<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GLB Model Normalizer for React Three Fiber</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: rgba(15, 23, 42, 0.9);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --border-subtle: rgba(148, 163, 184, 0.3);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background:
              radial-gradient(circle at top left, #0f172a 0, #020617 45%),
              radial-gradient(circle at bottom right, #020617 0, #000 60%);
      color: var(--text-main);
      overflow: hidden;
    }

    .app { display: flex; height: 100vh; width: 100vw; }

    .viewer-container {
      flex: 1.7;
      position: relative;
      padding: 16px;
    }

    .viewer-inner {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 24px;
      overflow: hidden;
      background: radial-gradient(circle at 10% 0%, #020617 0, #020617 30%, #000 100%);
      box-shadow:
              0 24px 80px rgba(15, 23, 42, 0.8),
              0 0 0 1px rgba(148, 163, 184, 0.2);
    }

    canvas#webgl { width: 100%; height: 100%; display: block; }

    .viewer-overlay {
      position: absolute;
      inset: 16px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
    }

    .pill {
      pointer-events: auto;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(12px);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.9);
    }

    .pill-strong { color: var(--text-main); font-weight: 500; }

    .sidebar {
      flex: 1;
      padding: 16px 20px 16px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel {
      flex: 1;
      background: var(--bg-soft);
      border-radius: 24px;
      padding: 18px 18px 16px;
      border: 1px solid var(--border-subtle);
      box-shadow:
              0 18px 60px rgba(15, 23, 42, 0.75),
              0 0 0 1px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      gap: 14px;
      backdrop-filter: blur(18px);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.85);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    .file-row { display: flex; gap: 8px; align-items: center; }

    .btn {
      border: none;
      border-radius: 999px;
      font-size: 12px;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at 0% 0%, #0ea5e9 0, #0369a1 40%, #020617 100%);
      color: white;
      box-shadow:
              0 12px 30px rgba(56, 189, 248, 0.4),
              0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
              0 18px 40px rgba(56, 189, 248, 0.55),
              0 0 0 1px rgba(56, 189, 248, 0.8);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.7);
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .file-input-wrapper {
      position: relative;
      flex: 1;
    }

    .file-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-faux {
      width: 100%;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px dashed rgba(148, 163, 184, 0.8);
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-faux span {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.8);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.7);
    }

    .field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .field-row + .field-row { margin-top: 6px; }

    .field-label { font-size: 12px; color: var(--text-soft); }

    .field-value {
      font-size: 12px;
      font-variant-numeric: tabular-nums;
      color: var(--text-main);
      text-align: right;
    }

    .field-input-group { display: flex; align-items: center; gap: 6px; }

    .input {
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 6px 10px;
      font-size: 12px;
      width: 72px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
    }

    .input-unit { font-size: 11px; color: var(--text-soft); }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      user-select: none;
    }

    .toggle input { display: none; }

    .toggle-slider {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      position: relative;
      transition: background 0.12s, border-color 0.12s;
    }

    .toggle-slider::before {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 1);
      top: 2px;
      left: 2px;
      transition: transform 0.14s, background 0.14s, box-shadow 0.14s;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .toggle input:checked + .toggle-slider {
      border-color: rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.9));
    }

    .toggle input:checked + .toggle-slider::before {
      transform: translateX(12px);
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    .divider {
      height: 1px;
      background: linear-gradient(
              to right,
              transparent,
              rgba(148, 163, 184, 0.4),
              transparent
      );
      margin: 4px 0;
    }

    .viewer-container.drag-over .viewer-inner {
      box-shadow:
              0 0 0 1px rgba(56, 189, 248, 0.9),
              0 0 0 2px rgba(37, 99, 235, 0.7),
              0 24px 80px rgba(56, 189, 248, 0.4);
    }

    @media (max-width: 960px) {
      .app { flex-direction: column; }
      .sidebar { padding: 8px 16px 16px; }
      .viewer-container { padding: 8px 16px; height: 50vh; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="viewer-container">
    <div class="viewer-inner">
      <canvas id="webgl"></canvas>
      <div class="viewer-overlay">
        <div class="pill">
          <span class="pill-dot"></span>
          <span class="pill-strong">Drag &amp; drop</span>
          <span>to preview and normalize .glb files</span>
        </div>
        <div class="pill">
          <span>R3F ready export</span>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Model normalizer</div>
          <div style="font-size: 12px; color: var(--text-soft); margin-top: 3px;">
            Center &amp; scale GLB for React Three Fiber, then export.
          </div>
        </div>
        <div class="badge">
          <span class="badge-dot"></span>
          Realtime
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="section-label">1. Load model</div>
        <div class="file-row" style="margin-top: 6px;">
          <div class="file-input-wrapper">
            <div class="file-faux">
              <span id="file-label">Choose or drop a .glb</span>
              <span style="font-size: 11px; opacity: 0.8;">Browse</span>
            </div>
            <input
                    id="file-input"
                    class="file-input"
                    type="file"
                    accept=".glb,model/gltf-binary"
            />
          </div>
          <button id="reset-btn" class="btn btn-ghost" type="button">
            Reset
          </button>
        </div>
      </div>

      <div>
        <div class="section-label" style="margin-top: 10px;">2. Normalize</div>

        <div class="field-row" style="margin-top: 6px;">
          <div class="field-label">Target max size</div>
          <div class="field-input-group">
            <input
                    id="target-size"
                    class="input"
                    type="number"
                    step="0.1"
                    min="0.01"
                    value="2.0"
            />
            <div class="input-unit">units</div>
          </div>
        </div>

        <div class="field-row">
          <label class="toggle">
            <input id="auto-normalize" type="checkbox" checked />
            <span class="toggle-slider"></span>
            <span>Auto normalize on load</span>
          </label>
          <button id="auto-btn" class="btn btn-primary" type="button">
            Auto convert
          </button>
        </div>
      </div>

      <div>
        <div class="section-label" style="margin-top: 10px;">3. Export</div>
        <div class="field-row" style="margin-top: 6px;">
          <div class="field-label">Convert current model</div>
          <button id="download-btn" class="btn btn-ghost" type="button" disabled>
            Download .glb
          </button>
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="section-label">Model diagnostics</div>
        <div style="margin-top: 6px;">
          <div class="field-row">
            <div class="field-label">Stage</div>
            <div id="info-stage" class="field-value">–</div>
          </div>
          <div class="field-row">
            <div class="field-label">Bounds (x × y × z)</div>
            <div id="info-size" class="field-value">–</div>
          </div>
          <div class="field-row">
            <div class="field-label">Center (x, y, z)</div>
            <div id="info-center" class="field-value">–</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 2px; display: flex; justify-content: space-between; align-items: center;">
        <div class="chip">
          <span class="chip-dot"></span>
          Origin-centered for R3F
        </div>
        <div style="font-size: 11px; color: var(--text-soft); text-align: right;">
          Tip: after export, use<br />
          <code>useGLTF("...")</code> directly.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Three.js + helpers from CDN, global THREE -->
<!-- If unpkg is blocked, swap to jsDelivr lines below -->
<script src="https://unpkg.com/three@0.165.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.165.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.165.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://unpkg.com/three@0.165.0/examples/js/exporters/GLTFExporter.js"></script>

<!-- ALTERNATIVE CDN (if above is blocked):
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.165.0/examples/js/exporters/GLTFExporter.js"></script>
-->

<script>
  // Run AFTER page load so we don't hit "THREE is not defined" while scripts are still loading
  window.addEventListener("load", function () {
    if (typeof THREE === "undefined") {
      console.error("Three.js did NOT load. Likely blocked by tracking protection / adblock / offline.");
      alert("Three.js failed to load.\n\nCheck DevTools > Network for errors on three.min.js.\nIf your browser blocks unpkg, try the jsDelivr lines in the HTML.");
      return;
    }

    console.log("Three.js loaded:", THREE.REVISION);

    let renderer, scene, camera, controls;
    const modelGroup = new THREE.Group();
    let currentModel = null;

    const fileInput = document.getElementById("file-input");
    const fileLabel = document.getElementById("file-label");
    const resetBtn = document.getElementById("reset-btn");
    const autoBtn = document.getElementById("auto-btn");
    const downloadBtn = document.getElementById("download-btn");
    const targetSizeInput = document.getElementById("target-size");
    const autoNormalizeCheckbox = document.getElementById("auto-normalize");

    const infoStage = document.getElementById("info-stage");
    const infoSize = document.getElementById("info-size");
    const infoCenter = document.getElementById("info-center");

    init();
    animate();

    function init() {
      const canvas = document.getElementById("webgl");
      renderer = new THREE.WebGLRenderer({
        canvas: canvas,
        antialias: true
      });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.outputEncoding = THREE.sRGBEncoding;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x020617);

      camera = new THREE.PerspectiveCamera(45, 1, 0.01, 5000);
      camera.position.set(3, 2, 5);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.06;
      controls.minDistance = 0.2;
      controls.maxDistance = 100;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x111827, 0.9);
      scene.add(hemi);

      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(5, 10, 5);
      dir.castShadow = true;
      scene.add(dir);

      const grid = new THREE.GridHelper(10, 10, 0x1f2933, 0x111827);
      grid.position.y = -1;
      scene.add(grid);

      const axes = new THREE.AxesHelper(1.5);
      axes.material.depthTest = false;
      axes.renderOrder = 2;
      scene.add(axes);

      scene.add(modelGroup);

      window.addEventListener("resize", resize);
      resize();
      setupUI();
    }

    function resize() {
      if (!renderer) return;
      const viewerInner = document.querySelector(".viewer-inner");
      const width = viewerInner.clientWidth;
      const height = viewerInner.clientHeight;

      renderer.setSize(width, height, false);
      if (camera) {
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      renderer.render(scene, camera);
    }

    function setupUI() {
      fileInput.addEventListener("change", event => {
        const file = event.target.files[0];
        if (!file) return;
        fileLabel.textContent = file.name;
        loadFile(file);
      });

      resetBtn.addEventListener("click", () => {
        fileInput.value = "";
        fileLabel.textContent = "Choose or drop a .glb";
        currentModel = null;
        modelGroup.clear();
        downloadBtn.disabled = true;
        updateInfo(null);
      });

      autoBtn.addEventListener("click", () => {
        if (!currentModel) return;
        const targetSize = parseFloat(targetSizeInput.value) || 2;
        normalizeModel(currentModel, targetSize);
        focusCameraOn(currentModel);
        updateInfo(currentModel, "Normalized (manual)");
      });

      downloadBtn.addEventListener("click", () => {
        if (!currentModel) return;
        exportCurrentModel();
      });

      const dropZone = document.querySelector(".viewer-container");
      dropZone.addEventListener("dragover", event => {
        event.preventDefault();
        dropZone.classList.add("drag-over");
      });
      dropZone.addEventListener("dragleave", event => {
        event.preventDefault();
        dropZone.classList.remove("drag-over");
      });
      dropZone.addEventListener("drop", event => {
        event.preventDefault();
        dropZone.classList.remove("drag-over");
        const file = event.dataTransfer.files[0];
        if (!file) return;
        fileInput.value = "";
        fileLabel.textContent = file.name;
        loadFile(file);
      });
    }

    function loadFile(file) {
      const url = URL.createObjectURL(file);
      const loader = new THREE.GLTFLoader();

      loader.load(
              url,
              gltf => {
                modelGroup.clear();
                currentModel = gltf.scene;
                modelGroup.add(currentModel);
                downloadBtn.disabled = false;

                updateInfo(currentModel, "Loaded");

                const targetSize = parseFloat(targetSizeInput.value) || 2;
                if (autoNormalizeCheckbox.checked) {
                  normalizeModel(currentModel, targetSize);
                  focusCameraOn(currentModel);
                  updateInfo(currentModel, "Normalized (auto)");
                } else {
                  focusCameraOn(currentModel);
                }

                URL.revokeObjectURL(url);
              },
              undefined,
              error => {
                console.error("Error loading GLB:", error);
                updateInfo(null, "Error loading file");
              }
      );
    }

    function normalizeModel(object, targetSize = 2) {
      const box = new THREE.Box3().setFromObject(object);
      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const scale = targetSize / maxDim;

      object.position.sub(center);      // center at origin
      object.scale.multiplyScalar(scale); // scale to target
    }

    function focusCameraOn(object) {
      const box = new THREE.Box3().setFromObject(object);
      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const fov = (camera.fov * Math.PI) / 180;
      let dist = maxDim / (2 * Math.tan(fov / 2));
      dist *= 1.8;

      camera.position.set(center.x + dist * 0.5, center.y + dist * 0.3, center.z + dist);
      camera.near = dist / 100;
      camera.far = dist * 100;
      camera.updateProjectionMatrix();

      controls.target.copy(center);
      controls.update();
    }

    function updateInfo(object, stage = "–") {
      if (!object) {
        infoStage.textContent = stage;
        infoSize.textContent = "–";
        infoCenter.textContent = "–";
        return;
      }

      const box = new THREE.Box3().setFromObject(object);
      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);

      infoStage.textContent = stage;
      infoSize.textContent =
              size.x.toFixed(3) +
              " × " +
              size.y.toFixed(3) +
              " × " +
              size.z.toFixed(3);
      infoCenter.textContent =
              center.x.toFixed(3) +
              ", " +
              center.y.toFixed(3) +
              ", " +
              center.z.toFixed(3);
    }

    function exportCurrentModel() {
      const exporter = new THREE.GLTFExporter();

      exporter.parse(
              currentModel,
              result => {
                let blob;
                let filename;

                if (result instanceof ArrayBuffer) {
                  blob = new Blob([result], { type: "model/gltf-binary" });
                  filename = "model_converted.glb";
                } else {
                  const json = JSON.stringify(result, null, 2);
                  blob = new Blob([json], { type: "application/json" });
                  filename = "model_converted.gltf";
                }

                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              },
              { binary: true }
      );
    }
  });
</script>
</body>
</html>
